# Publishing

As you develop the book, you make the draft book available to the public to get early feedback from readers, e.g., publish it to a website. After you finish writing the book, you need to think about options to formally publish it as either printed copies or e-books.

## RStudio Connect

In theory, you can render the book by yourself and publish the output anywhere you want. For example, you can host the HTML files on your own web server. We have provided a function `publish_book()` in **bookdown** to upload your book to https://bookdown.org, which is a website provided by RStudio to host your books for free.\index{bookdown.org} This website is built on top of ["RStudio Connect",](https://www.rstudio.com/products/connect/)\index{RStudio Connect} an RStudio product that allows you to deploy R Markdown documents, Shiny applications, dashboards, plots, and more to one convenient server.

You do not have to know much about RStudio Connect to publish your book at [bookdown.org](https://bookdown.org). All you need to do is to sign up at [bookdown.org/connect](https://bookdown.org/connect). The first time you run `bookdown::publish_book()`\index{bookdown::publish\_book()}, you will be asked to authorize **bookdown** to publish to your bookdown.org account. From that point onwards, you run `publish_book()` again and **bookdown** will no longer ask for authentication.

```{r publish-book-usage, eval=FALSE, code=formatR::usage(bookdown::publish_book, output=FALSE)}
```

The only argument of `publish_book()` that you may want to define is `render`. It determines whether you want to render the book before publishing. If you have run `render_book()` before, you do not need to change this argument, otherwise you may set it to `"local"`:

```{r eval=FALSE}
bookdown::publish_book(render = "local")
````

If you have set up your own RStudio Connect server, you can certainly publish the book there instead of at [bookdown.org](https://bookdown.org).

## GitHub Pages {#ghpages}

You can host your book on GitHub\index{GitHub} for free via GitHub Pages (https://pages.github.com).^[See the [GitHub Pages Help documents](http://bit.ly/2cvloKV) for more information.] The simplest approach is to publish your book as a [GitHub Project Page](https://help.github.com/en/articles/user-organization-and-project-pages#project-pages-sites) from a `/docs` folder on your `master` branch, which will then be available at `https://<USER>.github.io/<REPO>`. The main benefit to this approach is its simplicity, and the fact that you can track the source files for your book and the published HTML files in the same branch.

### The build-and-deploy pipeline sequence

This publishing approach sets up the following flow of events:

1. You create a local **bookdown** project in a GIT repository that is connected to a GitHub repository. The below steps assume you are on your `master` branch.
1. You change the output directory of your rendered book to a folder named `"docs"`.
1. You tell GitHub Pages to bypass using Jekyll to build your site.
1. You build your book locally, then push to send your local changes online to GitHub.
1. The push to the `master` branch triggers GitHub Pages to publish your book at: `https://<USER>.github.io/<REPO>`.
1. Rinse and repeat! Every push to `master` triggers the online version of your book to update.

The above is an overview- read on for step-by-step instructions.

### Before you begin

1. You need a GitHub (https://github.com/) account.^[If you are not familiar with GitHub, we suggest you read through the free online book ["Happy Git with R"](https://happygitwithr.com/) first before working through these instructions.]

1. Start with a **bookdown** project linked to a remote GitHub repository that you can push/pull to from your local copy. 

    ```{block2, publish_start, type='rmdnote'}
    If you don't have an existing book, you can create a simple **bookdown** book to practice with instead:
          
    + [Make a new repository on GitHub](https://happygitwithr.com/new-github-first.html#make-a-repo-on-github-2),
    + [Make a new RStudio Project via git clone](https://happygitwithr.com/new-github-first.html#new-rstudio-project-via-git-clone),
    + From your RStudio Project, run this command in your R console: `bookdown:::bookdown_skeleton(getwd())`,
    + [Change anything you want (or change nothing) and commit](https://happygitwithr.com/new-github-first.html#make-local-changes-save-commit-1),
    + [Push your local changes to GitHub](https://happygitwithr.com/new-github-first.html#push-your-local-changes-to-github).
    ```


### Change the output directory of your book

In your local **bookdown** project, open the `_bookdown.yml` file and change the output directory of your book to be `/docs` by adding this line:

```yaml
output_dir: "docs"
```

Save this file and close it.

### Tell GitHub Pages to bypass Jekyll

Create a hidden, empty file named `.nojekyll` from within R in your **bookdown** project root directory:

```
file.create(".nojekyll")
```

If you are using RStudio, you may need to refresh the viewer pane to see this new file. You can also use the terminal to create this file with the command `touch .nojekyll`.

This file is [necessary](https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages/) because GitHub Pages supports Jekyll ([jekyllrb.com](http://jekyllrb.com)), a static website builder, by default. You need the `.nojekyll` file because bookdown sites uses files or directories that start with underscores, and these files have a special status within the Jekyll framework. Because the **bookdown** HTML output is a static, standalone website, you need to tell GitHub that your website is *not* to be built via Jekyll. 

### Build your book, push to GitHub

Use whichever method from Chapter \@ref(build-the-book) you prefer, then push to send your local changes online to GitHub.

```{block2, type='rmdwarning'}
If you have previously added directories like `_book` and `_bookdown_files` to your remote GitHub repository, you'll want to take a few more steps to remove them:

+ Delete the folders locally
+ From the terminal: 
  + `git rm -r --cache _book/`
  + `git rm -r --cache _bookdown_files/`
  + `git commit -m 'Remove the rendered book files'`
  + `git push origin master`
```

### GitHub Pages Setup

In a browser, navigate to your repository on GitHub at `https://github.com/<USER>/<REPO>`. Then:

1. Confirm that you see a `/docs` folder and a `.nojekyll` file. 

1. Click on the repository's settings and under *GitHub Pages* and change the *Source* to be `master branch /docs folder`: 

  ![Screenshot of selecting master branch `/docs` folder for GitHub Pages](images/ghpages-masterdocs.png)

### Drawbacks and alternatives

This approach assumes:

1. You would like to store the rendered book (i.e., the `/docs` folder) on GitHub in your `master` branch. 
1. You are satisfied using a project domain name like `https://<USER>.github.io/<REPO>`.^[Note that you can use custom domains with GitHub Pages, see: https://help.github.com/articles/using-a-custom-domain-with-github-pages/.]

A very similar approach is to use Netlify continuous deployment, in which you connect a GitHub repository to a site published by Netlify. This approach is described in \@ref(netlify-cd).

Although it is relatively straight-forward approach to publish your book from a folder on your `master` branch, it means that you always need to build the book locally first, then push to send the built book online to GitHub. It can be very handy to instead automate the publishing process even more by building the book using a cloud service. Once set up, all you have to do is edit the `.Rmd` source files and push them to GitHub, and your book will be automatically built and published from the server side. To use this kind of cloud-based publishing workflow, you will want to utilize Travis CI\index{Travis CI} ([travis-ci.org](https://travis-ci.org)), discussed in sections \@ref(travis-branch) and \@ref(travis-nobranch).

## Netlify

Netlify ([netlify.com](https://www.netlify.com/)) is another free option for hosting your static **bookdown** site, similiar to [GitHub Pages](#ghpages). However, Netlify offers a few useful additional features that GitHub Pages does not, like [branch deploys](https://www.netlify.com/docs/continuous-deployment/#branches-deploys), [deploy previews](https://www.youtube.com/watch?v=s_4UL9oAcVE), and simple [redirect rules](https://www.netlify.com/docs/redirects/).^[For a more thorough comparison of Netlify versus GitHub Pages, see: https://yihui.name/en/2017/06/netlify-instead-of-github-pages/] When you create a static site through Netlify, your website will be online in a few seconds with a random subdomain name of the form `http(s)://random-word-12345.netlify.com` provided by Netlify (you can customize the name). 

To setup a new account, navigate to [Netlify](https://www.netlify.com/) and click on the *Sign Up* link. Sign up with *GitHub* to connect your GitHub and Netlify accounts (as shown below). If you use a different version control service, select GitLab or BitBucket instead.

![Sign up for Netlify through GitHub](images/netlify-sign-up.png)


### Drag-and-drop deploy

Even though we encouraged you to sign up by linking Netlify to your GitHub account, drag-and-drop deploy is a Netlify publishing option that does not rely on your **bookdown** project being in a GitHub repository. All you need for this approach is a **bookdown** project that you can build locally.

#### The build-and-deploy pipeline sequence

This publishing approach sets up the following flow of events:

1. You start with a local **bookdown** project.
1. You build your book locally to an output directory of choice (`_book` by default).
1. You log in to Netlify, and drag and drop the output directory into the Netlify browser-based user interface.
1. You make changes to your book, rebuild locally, then drag and drop the output directory again into Netlify to update.

The above is an overview- read on for step-by-step instructions.

#### Before you begin

1. You need a Netlify (https://netlify.com/) account.

1. Start with a **bookdown** project (it does not need to be in GitHub!). 

    ```{block2, type='rmdnote'}
    If you don't have an existing book, you can create a simple **bookdown** book to practice with instead:

    + Create a new project with the RStudio Project Wizard by doing *File > New Project > New Directory > Book Project using bookdown*.
    ```

#### Build your book

From your **bookdown** project, build your book locally using whichever method from Chapter \@ref(build-the-book) you prefer.

#### Deploy your site

Log in to Netlify and scroll to the bottom of the landing page where you should see a box like this:

![Screenshot of drag and drop deploy box on Netlify](images/netlify-drag-drop.png)

Then drag and drop the output directory from your **bookdown** project (`_book` by default, unless you changed this in your `_bookdown.yml` file). You should see your book deploys quickly with a random subdomain name of the form `http(s)://random-word-12345.netlify.com`.

#### Update your site

You *can* update this kind of site, but it is a manual update. Go to [Netlify.com](https://www.netlify.com/) and navigate to find your site, then click on *Deploys*. You should see this box (you may need to scroll to the bottom of this page):

![Screenshot of drag and drop deploy **update** box on Netlify](images/netlify-drag-drop-update.png)

Edit your book, build it locally again, then drag and drop the output directory here again. 

#### *Optional: change the default subdomain* {#netlify-subdomain} 

(ref:netlify-subdomain) Navigate to your site's landing page on [Netlify.com](https://www.netlify.com/), click on *Overview > Site Settings*. Under *Site information*, click on *Change site name* and update to `http(s)://<SUBDOMAIN-YOU-WANT-HERE>.netlify.com`. If you want to use a different domain, you need to configure some DNS records of the domain to point it to the Netlify server. 

(ref:netlify-subdomain)

#### Drawbacks and alternatives

This workflow is great to quickly share a book prototype, but is not ideal for books you are actively editing or collaborating on because every time you update your local version of the book, you need to manually upload the book to Netlify. You also aren't reaping the benefits of version control with this approach. As you might expect, there is an easier long-term solution! We can connect GitHub to Netlify and use [continuous deployment](#netlify-cd).

### Continuous deployment {#netlify-cd}

Continuous deployment means that when you push your code to a Git(Hub) repository, Netlify detects this push, then automatically publishes the updated site for you- no manual steps are needed after the initial setup. As described in the Netlify documentation (https://www.netlify.com/docs/continuous-deployment/):

> "Continuous deployment works by connecting a Git repository to a Netlify site and keeping the two in sync."

GitHub Pages is another method for continuous deployment, described in Chapter \@ref(ghpages), which similarly worked by connecting a GitHub repository to a GitHub Pages Project site and keeping the two in sync.

#### Before you begin

1. You need a Netlify (https://netlify.com/) account connected to your GitHub account.

1. Start with a **bookdown** project linked to a remote GitHub repository that you can push/pull to from your local copy. 

    ```{block2, publish_start, type='rmdnote'}
    ```

1. If you have been trying out other publishing approaches, you may want to undo some things in your **bookdown** project:

    ```{block2, publish_undo, type='rmdwarning'}
    + Delete the `.nojekyll` file locally if you made one- you don't need it.
    + Switch your output directory back to `_book` (the default). In your `_bookdown.yml` file, you can either comment out that line (`#`) or delete it.
      + If you want a different output directory, replace all future instances of `_book` with your output directory.
    + Edit your `.gitignore` to make sure that it does **not** include your output directory (i.e., `_book`). From R, you can do [`usethis::edit_git_ignore()`](https://usethis.r-lib.org/reference/edit.html).
    + Clean up commited files. If you placed a directory like `docs` in your GitHub repo, you need to do an extra step in the terminal to remove it with:<br>
    `git rm -r --cache docs/`<br>
    `git commit -m 'Remove the docs folder'`<br>
    `git push origin master`
    ```

#### The build-and-deploy pipeline sequence

This publishing approach sets up the following flow of events:

1. You start with a local **bookdown** project in a GIT repository that is connected to a GitHub repository. The below steps assume you are on your `master` branch.
1. You log in to Netlify and create a new site from GitHub.
1. You set the Netlify publish directory to be your book's output directory (the default is `_book`).
1. You build your book locally, then push your `master` branch to your GitHub repository.
1. The push to `master` triggers Netlify to publish your book from the output directory at: `http(s)://random-word-12345.netlify.com`.
1. Rinse and repeat! Every push to `master` triggers the online version of your book to update on your Netlify site.

The above is an overview- read on for step-by-step instructions.

#### Create a new Netlify site

+ Log in to Netlify.

+ Select *New site from Git*. 

+ Follow these next steps within Netlify's *Create a new site* wizard:

  + *Step 1: Connect to Git provider.* Select GitHub. At this point, you may see a pop-up to let you know that Netlify is being authorized to access your GitHub. 

  + *Step 2: Pick a repository.* Find the Git repository attached to your **bookdown** project and select it. You can select from all of your personal repositories, or use the drop-down to select an organization that you are a part of. 

  + *Step 3: Build options, and deploy!* Start with deploying the master branch only. For the "Basic build settings", leave the Build Command blank. For the Publish Directory, choose your output directory- this will be `_book` by default (no quotes needed).

#### (Re-)Build your book

In your local **bookdown** project, make a small insignificant change- you could add a `subtitle` field in the YAML of your `index.Rmd` file like:

```
--- 
title: "A Minimal Book Example"
subtitle: "I'm a book continuously deployed on Netlify!"
site: bookdown::bookdown_site
---
```
    
Build your book locally, then commit and push all changes to GitHub.

#### View on GitHub

View your GitHub account in your browser, navigate to your **bookdown** repository, and verify that all the files have been pushed to it successfully.

#### View on Netlify

On Netlify, go to your site's page and click on *Deploy* to watch the deploy progress. A few minutes after your last push to GitHub, you should see your extra line of text appear at `http(s)://random-word-12345.netlify.com`.

#### *Optional: change the default subdomain*

You may want to change the default subdomain given by Netlify, described previously in Chapter \@ref(netlify-subdomain).

(ref:netlify-subdomain)

#### Drawbacks and alternatives

This workflow is identical to that described in \@ref(ghpages) using GitHub Project Pages. This approach requires an additional service, Netlify, but that addition does not add any complexity in terms of file structures present in your repository. These two approaches are basically the same, and in fact you can host the same book source files on *both* a GitHub Project Page and a Netlify site. The main downside to both of these approaches is that ultimately the rendered book files are stored in your `master` branch on GitHub. Some users prefer to keep the `master` branch clear of all non-source files (i.e., `.html` files); if you are one of these users, you would probably prefer to use [Travis](#travis).

## Using Travis with branches {#travis-branch}

### About Travis {#travis}

Travis CI\index{Travis CI} ([travis-ci.com](https://travis-ci.com)) is a service that builds and checks your software in a virtual machine whenever you push changes to GitHub. It is free to use for public repositories on GitHub, and was designed for continuous integration (CI) of software packages. 

Connecting Travis CI to a GitHub repository means that whenever you push to that repository on GitHub, Travis will run certain commands/scripts on the latest version of your repository. These commands are specified in a YAML file named `.travis.yml` in the root directory of your repository, and they are usually for the purpose of testing software. However they are quite open-ended, meaning that you can run arbitrary commands on a Travis (virtual) machine. That means you can configure Travis to run your own scripts to build your book. Note that Travis only supports Ubuntu and Mac OS X at the moment, so you should have some basic knowledge about Linux/Unix commands.^[For more details about Travis, see the documentation page "Core Concepts for Beginners": https://docs.travis-ci.com/user/for-beginners/.]

```{block2, type='rmdnote'}
Be sure to visit [`travis-ci.com`](https://travis-ci.com), not `.org`. In the past, Travis offered separate platforms for private repositories on [`travis-ci.com`](https://travis-ci.com) and open source repositories on [`travis-ci.org`](https://travis-ci.org). However, there is now a single platform for all projects. If you want to activate a new repository – either public or private – on Travis CI, use [`travis-ci.com`](https://travis-ci.com). Existing projects will all be migrated to this platform.^[Read the original blog post announcing this change on the Travis CI site: https://blog.travis-ci.com/2018-05-02-open-source-projects-on-travis-ci-com-with-github-apps.]
```

### Why Travis + **bookdown**?

The major benefit to using Travis with a **bookdown** project is that you are able to make changes to your book source files without needing to locally render the book. Any change to any `.Rmd` file in your book that is pushed to GitHub will set this build-deploy pipeline in motion, even if you do not or cannot build the book locally. This may be useful both when collaborating with yourself or with other people. 

However, once you get to the stage where your book files are *stored* in the cloud on GitHub, there are several additional (and sometimes complicated) steps to have your book also *built* and *deployed* in the cloud with every push to GitHub. The good news is that you only need to do these steps once for every project! 

### Why deploy to a target branch?

In this section, we'll describe how to use Travis to build your book in the cloud, then push the built book online to a branch in your linked GitHub repository. After this, we will publish the site to either a GitHub Project Page or to Netlify- the workflows are almost identical. Why do this? 

First, this is a good workflow to start with if you are newer to using Travis and want to automate building and deploying your book using a cloud-based service. The major benefit to this approach is that your `master` branch on GitHub will no longer store the rendered book files (i.e., the folders `_book` and `_bookdown_files`). Instead, those files will be present in a separate branch: the `gh-pages` branch. This means that your master branch will contain source files *only*.

A second benefit here is that you will *not* experience a double-deployment problem. This happens when you trigger a new Travis build with a push from your `master` branch, *and* deploy your **bookdown** site from the same branch. What you would see then is that your **bookdown** site would go down temporarily after you push to GitHub, because no book would be there to publish! The site would return after Travis finishes the book build, but having your site go down (even if just temporarily) with every push is not ideal. So, this workflow is nice because deploys are only triggered once your book is built by Travis and pushed to the `gh-pages` branch. You will never need to directly push any local changes to the `gh-pages` branch manually; this is a branch that only Travis will push to.

Finally, this approach allows you to look at the rendered book built by Travis on GitHub. This can be an effective trouble-shooting tool when you have any output that is dynamically computed from R, as Travis output can be unpredictable (R versions, availability of certain R packages, system dependencies, network connection, etc). This approach lets you view exactly what ends up being published from the `gh-pages` branch.


### The build-and-deploy pipeline sequence

This publishing approach sets up the following flow of events:

1. You start with a local **bookdown** project in a GIT repository that is connected to a GitHub repository. The below steps assume you are on your `master` branch.
1. You set up your book to be built by Travis, meaning you get the following files in place locally:
    + `DESCRIPTION`
    + `.travis.yml`
    + *Optional but recommended*: you update your `.gitignore` file
1. You create a GitHub personal access token and store it as an environment variable in Travis.
1. You commit and push to send your local changes to GitHub.
1. The push to `master` triggers Travis to build your book and automatically push it to your `gh-pages` branch.
1. The push to your `gh-pages` branch automatically triggers either GitHub Pages or Netlify to publish your book from the output directory.
1. Rinse and repeat! Every push to the `master` branch triggers the online version of your book to update on your site.

The above is an overview- read on for step-by-step instructions.

### Before you begin

1. You need a GitHub (https://github.com/) account.^[If you are not familiar with GitHub, we suggest you read through the free online book ["Happy Git with R"](https://happygitwithr.com/) first before working through these instructions.]

1. You need to activate Travis CI (https://travis-ci.com).^[See [docs.travis-ci.com/user/getting-started](https://docs.travis-ci.com/user/getting-started) for how to get started with Travis CI.] 

    + Click *Sign up with GitHub*.
    
    + Accept the Authorization of Travis CI. You’ll be redirected to GitHub.
    
    + Click the green *Activate* button, and select the repository you want to use with Travis CI.

1. To publish to Netlify, you will need a Netlify (https://netlify.com/) account connected to your GitHub account, described in Chapter \@ref(netlify).

1. Start with a **bookdown** project linked to a remote GitHub repository that you can push/pull to from your local copy,  *and* that you have owner permissions for on GitHub.^[See: https://help.github.com/articles/access-permissions-on-github/.] 

    ```{block2, publish_start, type='rmdnote'}
    ```

1. If you have been trying out other publishing approaches, you may want to undo some things in your **bookdown** project:

    ```{block2, type='rmdwarning'}
    + Delete the `.nojekyll` file locally if you made one- you don't need it.
    + Switch your output directory back to `_book` (the default). In your `_bookdown.yml` file, you can either comment out that line (`#`) or delete it.
      + If you want a different output directory, replace all future instances of `_book` with your output directory.
    + Clean up commited files. If you placed a directory like `docs`, `_book`, or `_bookdown_files` in your GitHub repo, you need to do a few extra steps in the terminal to remove them with:<br>
    `git rm -r --cache docs/` # list directories with / at end <br>
    `git commit -m 'Remove rendered book folders'`<br>
    `git push origin master`
    ```


### Travis Setup {#travis-setup}

You will need to create two new files in your local **bookdown** project: a `DESCRIPTION` file and a `.travis.yml` file.

1. Since this Travis service is primarily for checking R packages, you will need a (fake) `DESCRIPTION` file as if the book repository were an R package. Create a new file named `DESCRIPTION` in your **bookdown** project root directory:

    ```{r create-desc, eval = FALSE}
    # from R
    file.create("DESCRIPTION")
    # or from the terminal
    # touch DESCRIPTION
    ```

    If you are using RStudio, you may need to refresh the viewer pane to see this new file. 

    The main thing in this file that matters for a **bookdown** project is the specification of dependencies, which correspond to packages that you plan to use in your book. These are specified in the `Imports` and `Remotes` fields: 

    ```dcf
    Package: placeholder
    Type: Book
    Title: Does not matter.
    Version: 0.0.1
    URL: https://github.com/<USER>/<REPO> # fill in USER and REPO
    Imports: bookdown, ggplot2, icon
    Remotes: ropenscilabs/icon
    ```
    
    List packages from CRAN or BioConductor in the `Imports` field of the `DESCRIPTION` file; this is equivalent to Travis running `install.packages()` and `library()` before building your book. 
    
    For packages on GitHub, you will need to add the package name to the `Imports` field as well, *and* include the `USER/REPO` in the `Remotes` field (equivalent to `devtools::install_github()`) (so GitHub packages will be listed in two places in this file). For example, in the example code above, we used the [**bookdown**](https://cran.rstudio.com/web/packages/bookdown/index.html) and [**ggplot2**](https://cran.r-project.org/web/packages/ggplot2/index.html) package versions from CRAN, and the development version of the [**icon**](https://github.com/ropenscilabs/icon) package from the rOpenSci Labs GitHub repository.
    
    The `URL` field is not required by Travis, but can allow you to take advantage of some helpful `browse_*()` functions from the **usethis** package ([usethis.r-lib.org](https://usethis.r-lib.org/)).
    
    You can enter all of these fields into the `DESCRIPTION` file by hand, or you may use the **usethis** package to add these elements from within R:
    
    ```{r usethis-desc, eval = FALSE}
    library(usethis)
    use_package("ggplot2") # add a CRAN package as a dependency
    use_dev_package("icon") # add a GitHub package as a dependency
    use_github_links() # add GitHub URL (requires a personal access token to be stored)
    ```
    

1. You tell Travis how to build the book in a new file called `.travis.yml`, which you create in your **bookdown** project root directory:

    ```{r create-yml, eval = FALSE}
    # from R
    file.create(".travis.yml")
    # or from the terminal
    # touch .travis.yml
    ```

    If you are using RStudio, you may need to refresh the viewer pane to see this new file. Below is a complete example of a `.travis.yml` file (be very careful with the indentation in this file as it is a YAML file, so tabs and white space do matter):

    ```yaml
    language: R
    cache:                          # optional
      packages: true                # optional
      directories: _bookdown_files  # optional
    pandoc_version: 2.3.1
    
    script:
    - Rscript -e 'bookdown::render_book("index.Rmd")'
    
    deploy:
      provider: pages
      local_dir: _book
      skip_cleanup: true
      github-token: $GITHUB_PAT    # Set in the settings page 
      on:
        branch: master
    ```

    This file tells Travis CI what to do:
    
    + The `language` key tells Travis to use a virtual machine that has R installed. 
    + The `script` section tells Travis how to build the book, here using the **bookdown** package function `render_book()`.
    + The `deploy` section gives Travis instructions for deploying the book when a push to the master branch is detected. The option `on` specifies that the deployment will only occur when the master branch is built. The `local_dir` option is the publish directory, which should be `_book` (unless you changed your `output_dir` in your `_bookdown.yml` file). Although not shown here, there is also a `target-branch` option, which specifies the branch where Travis should push the contents in the `local_dir` to, defaults to the `gh-pages` branch. Note that you do not need to create the `gh-pages` branch first- if one does not exist, Travis will create it on your first push.
    + *Optional: Caching on Travis.*  Caching on Travis is especially useful for saving build time if your book is very time-consuming to build. Here, we have cached the R packages, as well as the output directory.^[Normally you should cache at least two types of directories: the figure directory (e.g., `_main_files`) and the cache directory (e.g., `_main_cache`). These directory names may also be different if you have specified the **knitr** chunk options `fig.path` and `cache.path`, but I strongly recommend not changing these options. The figure and cache directories are stored under the `_bookdown_files` directory in the root directory of your book.]
    

### Connect Travis to GitHub {#travis-github}

You will need to grant Travis write access to your GitHub repository by providing a personal access token (PAT), and setting the deployment provider details in `.travis.yml`.^[The Travis documentation shows how to deploy a site to GitHub Pages after a successful build: [docs.travis-ci.com/user/deployment/pages](https://docs.travis-ci.com/user/deployment/pages).] Here are a few steps you may follow:

+ **Create a GitHub personal access token** 

  To create a personal access token for your GitHub account, follow these step-by-step instructions from ["Happy Git with R."](https://happygitwithr.com/github-pat.html) You may also find these [instructions from GitHub helpful](http://bit.ly/2cEBYWB). Select the `public_repo` or `repo` scope (`repo` is required for private repositories). You can view your PATs at [github.com/settings/tokens](https://github.com/settings/tokens). Be sure to copy the token to your clipboard. You may also wish to leave this browser window open while you navigate to Travis just in case. 

+ **Tell Travis your GitHub personal access token** 
    
  Go to `https://travis-ci.com/<USER>/<REPO>/settings` (or with the **usethis** package; the function `browse_travis(ext = "com")`) and save this PAT string as an "Environment variable", where `NAME` is anything you want it to be (we use `GITHUB_PAT` here as a placeholder only), and `VALUE` is where you paste the PAT from GitHub. You can leave the toggle button to right as is - this will keep your PAT private and will not show the value in your public build log. Click *Add*. 

  If you know how to install and use the [Travis command-line tool](https://docs.travis-ci.com/user/environment-variables#defining-encrypted-variables-in-travisyml), you may instead encrypt it in the environment variable `GITHUB_PAT` via command line `travis encrypt` and store it in `.travis.yml`, e.g `travis encrypt GITHUB_PAT=TOKEN`. 
  
    
### Push to GitHub {#travis-trigger}

+ **Update your `.gitignore`**

  You'll want to update your `.gitignore` file first before pushing your changes to GitHub, because your first push with the `.travis.yml` file in your repo will automatically trigger your first Travis build. Before doing this, you may wish to backup your local copies of the `_book` (unless you have modified your `output_dir` in your `_bookdown.yml` file), but you can safely delete and ignore both of these folders - these will now be built by Travis. You can open the `.gitignore` file and edit it directly. If your book was created as part of an R Project, your updated `.gitignore` would then look like this:

    ```
    .Rproj.user
    .Rhistory
    .RData
    .Ruserdata
    _book
    _bookdown_files
    ```
    
    You will still be able to build and preview your book locally (this will re-create your local `_book` folder), but those folders will no longer appear on your master branch in your remote GitHub repository.^[You must edit the `.gitignore` file **and** delete these local files, then commit/push to GitHub *before* building the book locally again for these changes to take effect.] 
    
    You could also use the **usethis** package to edit this file from within your R console. 
    
    ```{r usegitignore, eval = FALSE}
    ## install if needed:
    ## install.packages("usethis")

    library(usethis)
    # edit by hand
    edit_git_ignore()
    # or add to the text file 
    use_git_ignore(c("_book", "_bookdown_files"))
    ```
    
+ **Commit and push**

  Once you have your `DESCRIPTION`, `.travis.yml`, and `.gitignore` files ready, commit and push your changes to GitHub. This will trigger a new build on Travis; you should be able to watch your book's build progress on `https://travis-ci.org/<USER>/<REPO>` (or `usethis::browse_travis(ext = "com")`) . A successful build will end with log entries like:
    
    ```bash
    The command "Rscript -e 'bookdown::render_book("index.Rmd")'" exited with 0.
      
    Preparing deploy
    Deploying application
    Done. Your build exited with 0.
    ```
    
### Deploy! 

With a book successfully built by Travis and pushed to your `gh-pages` branch, you have two choices for deployment: GitHub Pages or Netlify. You can even deploy the same branch using both methods- it is up to you which service you prefer to use.

Following a successful build on Travis, navigate to your GitHub repository (you can do this from Travis by clicking on the octocat logo at the top of the page, or `usethis::browse_github()`). From `https://github.com/<USER>/<REPO>`, confirm that you see a `gh-pages` branch before moving on.

+ **Use GitHub Pages** 

  + From your online GitHub repository, click on the repository's settings and under *GitHub Pages* and change the *Source* to be *gh-pages branch*: 
    
    ![Screenshot of selecting gh-pages branch for GitHub Pages](images/ghpages-branch.png)


+ **Use Netlify** 

  + Log in to Netlify, then do: *New site from Git > GitHub*

  + In Netlify's *Create a new site* wizard, do this:

    + *Step 1: Connect to Git provider.* Select GitHub.
  
    + *Step 2: Pick a repository.* Pick your **bookdown** repository.
  
    + *Step 3: Build options, and deploy!* Under *Branch to deploy*, select `gh-pages` from the drop-down menu- leave all of the basic build settings blank. Deploy site.

+ *Optional: test your pipeline* 

  You only need to do the steps above in sequence *once* per project. To see how this works, you can test the pipeline now. In your local **bookdown** project, make a small insignificant change- for example, you could add a `subtitle` field in the YAML of your `index.Rmd` file like:

    ```
    --- 
    title: "A Minimal Book Example"
    subtitle: "I'm a book built in the cloud!"
    site: bookdown::bookdown_site
    ---
    ```
    
    Commit and push to GitHub (you do not have to build your book locally first!), then log onto Travis (`https://travis-ci.org/<USER>/<REPO>`) and GitHub (`https://github.com/<USER>/<REPO>`) and watch as your book gets built and committed to your `gh-pages` branch. Alternatively you could run these **usethis** functions in your R console to pull up both relevant websites:
    ```{r eval = FALSE}
    library(usethis)
    browse_travis(ext = "com")
    browse_github()
    ```
    
    A few minutes after your last push to GitHub, you should see your extra line of text appear at `https://<USER>.github.io/<REPO>` if you deployed to GitHub Pages. If you used Netlify, navigate to your site's page in the Netlify user interface and click on *Deploy* to watch the deploy progress: you should see your extra line of text appear at `http(s)://random-word-12345.netlify.com`.
    
### *Optional: separate build and deploy scripts*

With this setup working, you *could* separate your build and deploy scripts, rather than keeping them within a single `.travis.yml` file. With more complicated book builds, this may be preferred to manage the length of your `.travis.yml` file.

+ Edit your `.travis.yml` as follows:

  ```yaml
  language: R
  cache: packages
  pandoc_version: 2.3.1
  
  before_script:
    - chmod +x ./_build.sh
    - chmod +x ./_deploy.sh
  
  script:
    - ./_build.sh
    - ./_deploy.sh
  ```

+ Create two new Shell scripts in the `master` branch named `_build.sh` and `_deploy.sh`. 

+ An example `_build.sh` script could look like:

  ```bash
  Rscript -e "bookdown::render_book('index.Rmd', 'bookdown::gitbook')"
  Rscript -e "bookdown::render_book('index.Rmd', 'bookdown::pdf_book')"
  Rscript -e "bookdown::render_book('index.Rmd', 'bookdown::epub_book')"
  ```

+ An example `_deploy.sh` script could look like:

  ```bash
  # clone the repository to the mybook directory
  git clone -b gh-pages https://${GITHUB_PAT}@github.com/${TRAVIS_REPO_SLUG}.git mybook
  cd mybook
  cp -r ../_book/* ./
  git add --all *
  git commit -m "Update the book" || true
  git push -q origin gh-pages
  ```

  In the above script, the only thing you might need to change is `GITHUB_PAT` with the **name** you gave to your Travis Environment Variable that stores your GitHub personal access token- this name could have been anything. Also, if you specified a different output directory, replace `_book` with your output directory. `TRAVIS_REPO_SLUG` is a defined variable for Travis so do not change that.

### *Optional: customize commit messages in your deploy script*

You can further customize your commit messages to be more specific than "Update the book". With these changes, the commit messages in your `gh-pages` branch will be meaningful: you can see the shorthand commit ID and your commit message, and you can click on either to view the relevant commit history. 

+ Add one more line to `.travis.yml` in the `before_script` section as follows (keep all other YAML elements as before):

  ```
  before_script:
    - export DEPLOY_MSG="${TRAVIS_COMMIT:0:7} ${TRAVIS_COMMIT_MESSAGE:0:70}"
  ```

+ In your `_deploy.sh` file, **edit** the `git commit -m "Update the book" || true` line, replacing the generic commit message `"Update the book"` with `"$DEPLOY_MSG"`. 

  ```
  git commit -m "$DEPLOY_MSG" || true
  ```


### Demo repository

All above scripts and configurations can be found in the `bookdown-travis-branch-deploy` repository: [github.com/apreshill/bookdown-travis-branch-deploy](https://github.com/apreshill/bookdown-travis-branch-deploy). These two approaches are basically the same, and in fact you can host the same book source files on *both* a GitHub Project Page (https://apreshill.github.io/bookdown-travis-branch-deploy/) and a Netlify site (https://bookdown-travis-branch-deploy.netlify.com/). 


### Drawbacks and alternatives

The main downside to both of these approaches is that, although your book is built in the cloud, ultimately what is hosted are the rendered book files which sit on a branch in your online GitHub repository (although we have now moved them to the `gh-pages` branch, so they are at least not cluttering up your `master` branch). Some users strongly prefer to keep only source files, rather than rendered derivative files, in their GitHub repository. Those users will want to use [Travis without branches](#travis-nobranch).

## Using Travis without branches {#travis-nobranch}

The two workflows that we covered in Chapter \@ref(travis-branch) with Travis and **bookdown** relied on storing the rendered book files (i.e., those in the `_book` directory) in a branch within your GitHub repository. However, you can use Travis to build your book and deploy it using the cloud, meaning that you keep only the book source files in your GitHub repository. To do this, we will use Netlify, and make use of Netlify deploy contexts.

### Before you begin


+ Start with a **bookdown** project linked to a remote GitHub repository that you can push/pull to from your local copy, *and* that you have owner permissions for on GitHub.^[If you do not have one, you may wish to follow a "New project, GitHub first" workflow (See https://happygitwithr.com/new-github-first.html). After creating a new RStudio Project via git clone, you may run this command in your R console to build a simple **bookdown** book to practice with `bookdown:::bookdown_skeleton(getwd())`.] 

+ Follow all of the [steps outlined](#travis-setup) to setup Travis (\@ref(travis-setup)).^[For this workflow, you do not need to setup a GitHub personal access token as described in Chapter \@ref(travis-github), as we are not going to instruct Travis to write files to our GitHub repository.]

+ Follow all of the [steps outlined](#travis-trigger) to edit your `.gitignore` file and push to GitHub (\@ref(travis-trigger)).

+ Navigate to your GitHub repository in a browser window (`https://github.com/<USER>/<REPO>` or open from within R with `usethis::browse_github()`); it should now have the following files in place:

  + `DESCRIPTION`, 
  
  + `.travis.yml`, and 
  
  + `.gitignore` that includes `_book` (or whatever your `output_dir` is from your `_bookdown.yml` file) and `_bookdown_files`

+ Navigate to your site on Travis (`https://travis-ci.com/<USER>/<REPO>` or open from within R with `usethis::browse_travis(ext = "com")`). Your most recent build should be *green* and end with log entries like:
    
  ```bash
  The command "Rscript -e 'bookdown::render_book("index.Rmd")'" exited with 0.
    
  Preparing deploy
  Deploying application
  Done. Your build exited with 0.
  ```

### Netlify via UI {#netlify-ui}

**Setup Travis**

You will need to create two new files in your local **bookdown** project: a `DESCRIPTION` file and a `.travis.yml` file. For more narrative around these two files, you may review Chapter \@ref(travis-setup).

  1. Create a new file named `DESCRIPTION` in your **bookdown** project root directory:

    ```{r ref.label="create-desc", eval = FALSE}
    ```

  Specify your book dependencies in the `Imports` and `Remotes` fields: 

    ```dcf
    Package: placeholder
    Type: Book
    Title: Does not matter.
    Version: 0.0.1
    URL: https://github.com/<USER>/<REPO> # fill in USER and REPO
    Imports: bookdown, ggplot2, icon
    Remotes: ropenscilabs/icon
    ```
    
  You can enter these fields into the `DESCRIPTION` file by hand, or you may use the **usethis** package to add these elements from within R:
    
    ```{r ref.label="usethis-desc", eval = FALSE}
    ```
    

1. You tell Travis how to build the book in a new file called `.travis.yml`, which you create in your **bookdown** project root directory:

    ```{r ref.label="create-yml", eval = FALSE}
    ```

    If you are using RStudio, you may need to refresh the viewer pane to see this new file. Below is a complete example of a `.travis.yml` file (be very careful with the indentation in this file as it is a YAML file, so tabs and white space do matter):

    ```yaml
    language: R
    cache:                          # optional
      packages: true                # optional
      directories: _bookdown_files  # optional
    pandoc_version: 2.3.1
    
    script:
    - Rscript -e 'bookdown::render_book("index.Rmd")'
    
    deploy:
      provider: pages
      local_dir: _book
      skip_cleanup: true
      github-token: $GITHUB_PAT    # Set in the settings page 
      on:
        branch: master
    ```

    This file tells Travis CI what to do:
    
    + The `language` key tells Travis to use a virtual machine that has R installed. 
    + The `script` section tells Travis how to build the book, here using the **bookdown** package function `render_book()`.
    + The `deploy` section gives Travis instructions for deploying the book when a push to the master branch is detected. The option `on` specifies that the deployment will only occur when the master branch is built. The `local_dir` option is the publish directory, which should be `_book` (unless you changed your `output_dir` in your `_bookdown.yml` file). Although not shown here, there is also a `target-branch` option, which specifies the branch where Travis should push the contents in the `local_dir` to, defaults to the `gh-pages` branch. Note that you do not need to create the `gh-pages` branch first- if one does not exist, Travis will create it on your first push.
    + *Optional: Caching on Travis.*  Caching on Travis is especially useful for saving build time if your book is very time-consuming to build. Here, we have cached the R packages, as well as the output directory.^[Normally you should cache at least two types of directories: the figure directory (e.g., `_main_files`) and the cache directory (e.g., `_main_cache`). These directory names may also be different if you have specified the **knitr** chunk options `fig.path` and `cache.path`, but I strongly recommend not changing these options. The figure and cache directories are stored under the `_bookdown_files` directory in the root directory of your book.]
    
    
+ **Create a Netlify personal access token** 

  Log in to Netlify, and go to your account by clicking on your profile image at the top right, then select **"OAuth applications"** (https://app.netlify.com/account/applications). The Netlify site will lead you through two steps to generate then copy a personal access token (you may want to keep this browser window open).


+ **Tell Travis your Netlify personal access token** 

  On Travis, go to settings (`https://travis-ci.org/<USER>/<REPO>/settings` or `usethis::browse_travis(ext = "com")`) and enter a new **"Environment variable"**. The name of the variable should be `NETLIFY_AUTH_TOKEN`, and the value should be the personal access token from Netlify.

+ **Create a new Netlify site** 

  + Go back to Netlify, then do: *New site from Git > GitHub*

  + Click on *Deploy site* (don't change the branch to deploy or enter any basic build settings). We will override these in a moment so do not worry when your site does not deploy!

  + Go to your site's main page on Netlify then do: *Overview > General > Site details > Site information*. What you want is your new site's `API ID`, which is a long string of numbers and letters. Copy that string; we need to add it to your `.travis.yml` file.

+ **Instruct Travis how to build and deploy the book** 

  Create (or edit) the `.travis.yml` file for your **bookdown** project as follows:

    ```
    language: R
    cache:
      packages: true
      directories:
      - $HOME/.npm
    pandoc_version: 2.3.1
    
    before_install:
      - nvm install stable
      - npm install netlify-cli -g
    
    env:
      - NETLIFY_SITE_ID=216f9e98-82ae-4699-87b6-5635a7f7f943
      # NETLIFY_AUTH_TOKEN set in travis settings
    
    script:
    - Rscript -e 'bookdown::render_book("index.Rmd")'
    
    deploy:
      - provider: script
        script: netlify deploy --dir _book --prod
        skip_cleanup: true
        on:
          branch: master
    ```
    
    This `.travis.yml` has a lot going on! The top portion is similar to the one we used earlier in Chapter \@ref(travis-setup). We have also added:
    
    + A `before_install` section, which installs the Netlify Command Line Interface [netlify.com/docs/cli](https://www.netlify.com/docs/cli/). This relies on Node.js version 8 or higher, which is installed on the first line that starts with `nvm` (which stands for "node version manager"). The next line installs the Netlify tool using `npm`, a command line interface program to manage node.js libraries (stands for node package manager). 
    
    + An `env` section, which is where you store the Netlify `API ID` as the `NETLIFY_SITE_ID`. This tells Travis where to deploy the built book. 
    
    + The `script` tells Travis how to build the book (the same script as we used in Chapter \@ref(travis-yml)). 
    
    + The `deploy` section tells Travis to use a script to deploy, then we use the Netlify Command Line Interface tool to deploy the build directory `_book` (this would be different if you changed the `output_dir` in your `_bookdown.yml`), and we tell Netlify to use the production context with the `--prod` flag.
    
+ **Trigger Travis to Build & Deploy**
    
  Once you have your `DESCRIPTION`, `.travis.yml`, and `.gitignore` files ready, commit and push your changes to GitHub. This will trigger a new build on Travis; you should be able to watch your book's build progress on `https://travis-ci.org/<USER>/<REPO>` (or `usethis::browse_travis(ext = "com")`). A successful build will end with log entries like:
    
      ```bash
      The command "Rscript -e 'bookdown::render_book("index.Rmd")'" exited with 0.
      
      Preparing deploy
      Deploying application
      Done. Your build exited with 0.
      ```
    
+ **Instruct Netlify to Do Manual Deploys Only** 

  The final step here is critical! Without this step, Netlify will attempt to deploy every time you push to your master branch on GitHub. This means two things will happen: 1) your site will go down when you first push, because there is no book to deploy (as Travis has not yet built it!), and 2) you'll have two deploys for every push (the second one deploys from Travis and so it will work). We need to disable this Netlify feature. Go online to Netlify and go to your site's *Overview > Site settings > Build & deploy*.  Scroll down to **"Deploy contexts"** and enter these settings:
  
  ![On Netlify, change production branch to `no-branch`, and branch deploys to "None: Deploy on the production branch"](images/netlify-deploy-contexts.png)
  
  These settings instruct Netlify to only do "manual deploys" - those that we tag with the production context label. If you look at our deploy script in your `.travis.yml`, we used the tag `--prod` to do this. You won't use this tag yourself- you'll only enable Travis to use it.
  
#### *Optional: test your pipeline*

In your local **bookdown** project, make a small insignificant change - you could add a `subtitle` field in the YAML of your `index.Rmd` file like:

```
--- 
title: "A Minimal Book Example"
subtitle: "I'm a book built and deployed with sorcery in the cloud!"
site: bookdown::bookdown_site
---
```
    
Commit and push to GitHub (note: you do not have to build your book locally first!), then log onto Travis (`https://travis-ci.org/<USER>/<REPO>`) and GitHub (`https://github.com/<USER>/<REPO>`) and watch as your book gets built and committed to your `gh-pages` branch. Alternatively you could run these **usethis** functions in your R console to pull up both relevant websites:

```{r eval = FALSE}
library(usethis)
browse_travis(ext = "com")
browse_github()
```
    
On Netlify, go to your site's page and click on "Deploy" to watch the deploy progress. A few minutes after your last push to GitHub, you should see your extra line of text appear at `http(s)://random-word-12345.netlify.com`. 

  
#### *Optional: customize commit messages in your deploy script*

You can further customize your commit messages to be more specific. With these changes, the commit messages in your Netlify deploy logs will be meaningful: you can see the shorthand commit ID and your commit message for every site deploy.

+ Add one more line to `.travis.yml` in the `before_install` section as follows (keep all other YAML elements as before):

  ```
  before_install:
    - export DEPLOY_MSG="${TRAVIS_COMMIT:0:7} ${TRAVIS_COMMIT_MESSAGE:0:70}"
  ```

+ Add `--message "$DEPLOY_MSG"` to the Netlify deploy script, also in your `.travis.yml` file. 

  ```
  deploy:
  - provider: script
    script: netlify deploy --dir _book --prod --message "$DEPLOY_MSG"
    skip_cleanup: true
    on:
      branch: master
  ```

#### Demo repository

All above scripts and configurations can be found in the `bookdown-travis-production-context` repository: [github.com/apreshill/bookdown-travis-production-context](https://github.com/apreshill/bookdown-travis-production-context).

### 04: Netlify from command line {#netlify-cli}

## Publishers

Besides publishing your book online, you can certainly consider publishing it with a publisher\index{publisher}. For example, this book was published with Chapman & Hall/CRC, and there is also a free online version at [bookdown.org/yihui/bookdown](https://bookdown.org/yihui/bookdown) (with an agreement with the publisher). Another option that you can consider is self-publishing (https://en.wikipedia.org/wiki/Self-publishing) if you do not want to work with an established publisher. Pablo Casas has written two blog posts that you may find useful: ["How to self-publish a book"](https://blog.datascienceheroes.com/how-to-self-publish-a-book/) and ["How to self-publish a book: customizing bookdown"](https://blog.datascienceheroes.com/how-to-self-publish-a-book-customizing-bookdown/).

It will be much easier to publish a book written with **bookdown** if the publisher you choose supports LaTeX.\index{LaTeX} For example, Chapman & Hall provides a LaTeX class named `krantz.cls`, and Springer provides `svmono.cls`. To apply these LaTeX classes to your PDF book, set `documentclass` in the YAML metadata of `index.Rmd` to the class filename (without the extension `.cls`).

The LaTeX class is the most important setting in the YAML metadata. It controls the overall style of the PDF book. There are often other settings you want to tweak, and we will show some details about this book below.

The YAML metadata of this book contains these settings:

```yaml
documentclass: krantz
lot: yes
lof: yes
fontsize: 12pt
monofont: "Source Code Pro"
monofontoptions: "Scale=0.7"
```

For the PDF book, the field `lot: yes` means we want the List of Tables, and similarly, `lof` means List of Figures. The base font size is `12pt`, and we used [Source Code Pro](https://www.fontsquirrel.com/fonts/source-code-pro) as the monospaced (fixed-width) font, which is applied to all program code in this book.

In the LaTeX preamble (Section \@ref(yaml-options)), we have a few more settings. First, we set the main font\index{font} to be [Alegreya](https://www.fontsquirrel.com/fonts/alegreya), and since this font does not have the <span style="font-variant:small-caps;">Small Capitals</span> feature, we used the Alegreya SC font.

```latex
\setmainfont[
  UprightFeatures={SmallCapsFont=AlegreyaSC-Regular}
]{Alegreya}
```

The following commands make floating environments\index{floating environment} less likely to float by allowing them to occupy larger fractions of pages without floating.

```latex
\renewcommand{\textfraction}{0.05}
\renewcommand{\topfraction}{0.8}
\renewcommand{\bottomfraction}{0.8}
\renewcommand{\floatpagefraction}{0.75}
```

Since `krantz.cls` provided an environment `VF` for quotes, we redefine the standard `quote` environment to `VF`. You can see its style in Section \@ref(markdown-syntax).

```latex
\renewenvironment{quote}{\begin{VF}}{\end{VF}}
```

Then we redefine hyperlinks to be footnotes, because when the book is printed on paper, readers are not able to click on links in text. Footnotes will tell them what the actual links are.

```latex
\let\oldhref\href
\renewcommand{\href}[2]{#2\footnote{\url{#1}}}
```

We also have some settings for the `bookdown::pdf_book` format in `_output.yml`\index{\_output.yml}:

```yaml
bookdown::pdf_book:
  includes:
    in_header: latex/preamble.tex
    before_body: latex/before_body.tex
    after_body: latex/after_body.tex
  keep_tex: yes
  dev: "cairo_pdf"
  latex_engine: xelatex
  citation_package: natbib
  template: null
  pandoc_args: --top-level-division=chapter
  toc_unnumbered: no
  toc_appendix: yes
  quote_footer: ["\\VA{", "}{}"]
  highlight_bw: yes
```

All preamble settings we mentioned above are in the file `latex/preamble.tex`, where we also specified that the front matter starts:

```latex
\frontmatter
```
In `latex/before_body.tex`, we inserted a few blank pages required by the publisher and wrote the dedication page.
Before the first chapter of the book, we inserted

```latex
\mainmatter
```

so that LaTeX knows to change the page numbering style from Roman numerals (for the front matter) to Arabic numerals (for the book body).

We printed the index in `latex/after_body.tex` (Section \@ref(latex-index)).

The graphical device (`dev`) for saving plots was set to `cairo_pdf` so that the fonts are embedded in plots, since the default device `pdf` does not embed fonts. Your copyeditor is likely to require you to embed all fonts used in the PDF, so that the book can be printed exactly as it looks, otherwise certain fonts may be substituted and the typeface can be unpredictable.

The `quote_footer` field was to make sure the quote footers were right-aligned: the LaTeX command `\VA{}` was provided by `krantz.cls` to include the quote footer.

The `highlight_bw` option was set to true so that the colors in syntax highlighted code blocks were converted to grayscale, since this book will be printed in black-and-white.

The book was compiled to PDF through `xelatex` to make it easier for us to use custom fonts.

All above settings except the `VF` environment and the `\VA{}` command can be applied to any other LaTeX document classes.

In case you want to work with Chapman & Hall as well, you may start with the copy of `krantz.cls` in our repository (https://github.com/rstudio/bookdown/tree/master/inst/examples) instead of the copy you get from your editor. We have worked with the LaTeX help desk to fix quite a few issues with this LaTeX class, so hopefully it will work well for your book if you use **bookdown**.
